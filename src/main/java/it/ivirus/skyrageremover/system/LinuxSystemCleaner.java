package it.ivirus.skyrageremover.system;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.file.Files;

public class LinuxSystemCleaner implements SystemCleaner {

	@Override
	public boolean isInfected() throws IOException {
		BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "systemctl status vmd-gnu"}).getInputStream()));
		String line;
		while (true) {
			line = bufferedReader.readLine();
			if (line == null) return false;
			if (line.contains("loaded")) {
				return true;
			}
		}
	}

	@Override
	public void clean() throws IOException {
		File fileVmd = new File("/bin/vmd-gnu");
		File fileService = new File("/etc/systemd/system/vmd-gnu.service");
		
		try {
			Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "systemctl stop vmd-gnu"}).waitFor();
			Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "systemctl disable vmd-gnu"}).waitFor();
		} catch (InterruptedException e) {
			System.err.println("YOU ABORTED THE CLEANING PROCESS. YOU ARE STILL INFECTED.");
		}

		if (!fileVmd.canWrite() || !fileService.canWrite()) {
			System.err.println("YOU ARE STILL INFECTED. CHECK IF YOU HAVE PERMISSION TO WRITE TO FILES: /bin/vmd-gnu and /etc/systemd/system/vmd-gnu.service");
			System.err.println("You can also remove files manually. remember to execute after delete: systemctl disable vmd-gnu");
		}

		Files.deleteIfExists(fileVmd.toPath());
		Files.deleteIfExists(fileService.toPath());
	}
}
