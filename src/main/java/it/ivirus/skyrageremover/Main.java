package it.ivirus.skyrageremover;


import org.objectweb.asm.ClassReader;
import org.objectweb.asm.ClassWriter;
import org.objectweb.asm.tree.*;

import java.io.*;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.List;
import java.util.Scanner;
import java.util.jar.JarFile;
import java.util.jar.JarOutputStream;
import java.util.jar.Manifest;
import java.util.zip.ZipEntry;
import java.util.zip.ZipFile;
import java.util.zip.ZipOutputStream;

public class Main {

    public List<File> jars = new ArrayList<>();

    public static void main(String[] args) throws Throwable {
        if (args.length != 2) {
            System.err.println("Start with: java -jar MalwareSkyrageRemover.jar <directory-to-scan> <output-directory>");
            System.err.println("Example: java -jar MalwareSkyrageRemover.jar ./ ./cleanjars");
            Thread.sleep(5000);
            return;
        }

        Main main = new Main();
        File output = new File(args[1]);
        if (!output.exists())
            output.mkdir();

        System.out.println("");
        System.out.println(":::    :::  ::::::::  :::    ::: ::::::::::: :::::::::::     :::     ");
        System.out.println(":+:    :+: :+:    :+: :+:    :+:     :+:         :+:       :+: :+:   ");
        System.out.println("+:+    +:+ +:+    +:+  +:+  +:+      +:+         +:+      +:+   +:+  ");
        System.out.println("+#++:++#++ +#+    +:+   +#++:+       +#+         +#+     +#++:++#++: ");
        System.out.println("+#+    +#+ +#+    +#+  +#+  +#+      +#+         +#+     +#+     +#+ ");
        System.out.println("#+#    #+# #+#    #+# #+#    #+#     #+#     #+# #+#     #+#     #+# ");
        System.out.println("###    ###  ########  ###    ### ###########  #####      ###     ### ");
        System.out.println("");
        System.out.println("Developer: iVirus_");
        System.out.println("Telegram: https://t.me/HoxijaChannel");
        System.out.println("Discord: https://discord.io/hoxija");
        System.out.println("");

        System.out.println("Checking jars...");
        System.out.println("");

        main.getJars(args[0]);

        for (File file : main.jars) {
            System.out.println(file.getName() + " is infected.");
        }
        System.out.println("");
        System.out.println("Total jars infected: " + main.jars.size());

        String x = "1";
        Scanner scanner = new Scanner(System.in);
        while (!x.equals("0")) {
            System.out.println("");
            System.out.println("Menu (OS: " + OperatingSystem.getSystem().getString() + "):");
            System.out.println("1) Clean jars");
            System.out.println("2) Clean operating system");
            System.out.println("0) Exit");
            System.out.println("---------------------------------");
            x = main.chooseAction(scanner, output);
        }


    }

    private String chooseAction(Scanner scanner, File output) throws Throwable {
        String value = scanner.nextLine();
        switch (value.toLowerCase()) {
            case "1": {
                System.out.println("I'm cleaning your jars! This may take some time.");
                for (int i = 0; i < this.jars.size(); i++) {
                    this.runRemover(this.jars.get(i), output);
                    System.out.println("Jar cleaned: " + this.jars.get(i).getName());
                    System.out.println("Status: " + i + 1 + "/" + this.jars.size());
                }
                System.out.println("Finished.");
                break;
            }
            case "2": {
                System.out.println("Checking your OS...");
                this.cleanSystem();
                break;
            }
            case "0": {
                System.out.println("Exiting...");
                break;
            }
            default: {
                System.err.println("Option not found, try again");
            }
        }
        return value;
    }

    public void getJars(String folder) {
        File directory = new File(folder);

        File[] fList = directory.listFiles();
        if (fList != null)
            for (File file : fList) {
                if (file.isFile()) {
                    if (file.getName().toLowerCase().endsWith(".jar")) {
                        try (ZipFile zip = new ZipFile(file)) {
                            Enumeration<? extends ZipEntry> entries = zip.entries();
                            while (entries.hasMoreElements()) {
                                ZipEntry zipEntry = entries.nextElement();
                                zipEntry.setCompressedSize(-1L);
                                if (zipEntry.getName().endsWith("plugin-config.bin")) {
                                    this.jars.add(file);
                                    break;
                                }
                            }

                        } catch (IOException e) {
                            throw new RuntimeException(e);
                        }

                    }
                } else if (file.isDirectory()) {
                    getJars(file.getAbsolutePath());
                }
            }
    }

    public void runRemover(File file, File filePath) throws Throwable {
        JarFile jarFile = new JarFile(String.valueOf(file.toPath()));
        JarOutputStream out = new JarOutputStream(Files.newOutputStream(new File(filePath.getAbsolutePath() + "/" + file.getName()).toPath()));
        Enumeration<? extends ZipEntry> entries = jarFile.entries();
        String eventuallyMainClass = "hoxija";

        Manifest manifest = jarFile.getManifest();

        if (eventuallyMainClass.equals("hoxija") && manifest != null && manifest.getMainAttributes().getValue("Main-Class") != null) {
            eventuallyMainClass = manifest.getMainAttributes().getValue("Main-Class");
            eventuallyMainClass = eventuallyMainClass.replaceAll("\\.", "/");
        }
        while (entries.hasMoreElements()) {
            ZipEntry zipEntry = entries.nextElement();
            zipEntry.setCompressedSize(-1L);

            if (zipEntry.getName().endsWith(".class")) {
                try (InputStream in = jarFile.getInputStream(zipEntry)) {
                    ClassReader classReader = new ClassReader(in);
                    ClassNode classNode = new ClassNode();
                    classReader.accept(classNode, 0);
                    if (classNode.superName == null) continue;
                    if ((classNode.name).equals("Updater")) continue;
                    if (!eventuallyMainClass.equals("hoxija")) {
                        if ((classNode.name).equals(eventuallyMainClass)) {
                            outloop:
                            for (MethodNode methodNode : classNode.methods) {
                                for (AbstractInsnNode insnNode : methodNode.instructions) {
                                    if (insnNode instanceof MethodInsnNode) {
                                        MethodInsnNode methodInsnNode = (MethodInsnNode) insnNode;
                                        if (isInstruction(methodInsnNode)) {
                                            if ((methodInsnNode.owner + "." + methodInsnNode.name).equalsIgnoreCase("Updater.init")) {
                                                methodNode.instructions.remove(insnNode);
                                                break outloop;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } else if (classNode.superName.equals("org/bukkit/plugin/java/JavaPlugin")) {
                        outloop:
                        for (MethodNode methodNode : classNode.methods) {
                            for (AbstractInsnNode insnNode : methodNode.instructions) {
                                if (insnNode instanceof MethodInsnNode) {
                                    MethodInsnNode methodInsnNode = (MethodInsnNode) insnNode;
                                    if (isInstruction(methodInsnNode)) {
                                        if ((methodInsnNode.owner + "." + methodInsnNode.name).equalsIgnoreCase("Updater.init")) {
                                            methodNode.instructions.remove(insnNode);
                                            break outloop;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    ClassWriter cw = new ClassWriter(1);
                    classNode.accept(cw);
                    ZipEntry newEntry = new ZipEntry(zipEntry.getName());
                    out.putNextEntry(newEntry);
                    writeToFile(out, new ByteArrayInputStream(cw.toByteArray()));
                } catch (Exception e) {
                    e.printStackTrace();
                }
                continue;
            }
            if (zipEntry.getName().equals("plugin-config.bin")) continue;
            out.putNextEntry(zipEntry);
            writeToFile(out, jarFile.getInputStream(zipEntry));
        }
        jarFile.close();
        out.close();
    }

    private void cleanSystem() {
        try {
            if (OperatingSystem.getSystem() == OperatingSystem.LINUX) {
                if (isSystemCompromised(OperatingSystem.LINUX)) {
                    System.out.println("Your system seems to be compromised by Skyrage malware.");
                    System.out.println("I'm cleaning your OS.");
                    this.cleanLinuxSystem();
                } else {
                    System.out.println("Your system does not seems to be compromised by Skyrage malware.");
                }
            } else if (OperatingSystem.getSystem() == OperatingSystem.WINDOWS) {
                if (isSystemCompromised(OperatingSystem.WINDOWS)) {
                    System.out.println("Your system seems to be compromised by Skyrage malware.");
                    System.out.println("I'm cleaning your OS.");
                    File file = isCheckedCompromised();
                    if (file != null) {
                        this.cleanWindowsSystem(file);
                    }
                } else {
                    System.out.println("Your system does not seems to be compromised by Skyrage malware.");
                }
            } else {
                System.err.println("ERROR: OS ot recognized...");
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

    }

    private boolean isSystemCompromised(OperatingSystem operatingSystem) throws IOException {
        if (operatingSystem == OperatingSystem.LINUX) {
            BufferedReader bufferedReader = new BufferedReader(
                    new InputStreamReader(Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "systemctl status vmd-gnu"}).getInputStream()));
            String line;
            while (true) {
                line = bufferedReader.readLine();
                if (line == null) return false;
                if (line.contains("loaded")) {
                    return true;
                }

            }
        } else if (operatingSystem == OperatingSystem.WINDOWS) {
            BufferedReader bufferedReader = new BufferedReader(
                    new InputStreamReader(Runtime.getRuntime().exec("wmic startup get caption,command").getInputStream()));
            String line;
            while (true) {
                line = bufferedReader.readLine();
                if (line == null) return false;

                if (line.contains("javaw")) {
                    System.out.println("Your system could be compromised, I'm performing other checks...");
                    return true;
                }
            }
        }
        return false;
    }

    private File isCheckedCompromised() {
        File directory = new File(System.getenv("APPDATA") + File.separator + "Microsoft" + File.separator
                + "Windows" + File.separator + "Start Menu" + File.separator + "Programs" + File.separator + "Startup");
        File[] fList = directory.listFiles();
        if (fList != null)
            for (File file : fList) {
                if (file.isFile()) {
                    if (file.getName().toLowerCase().endsWith(".jar")) {
                        try (JarFile jarFile = new JarFile(String.valueOf(file.toPath()));) {
                            Enumeration<? extends ZipEntry> entries = jarFile.entries();
                            String eventuallyMainClass = "hoxija";

                            Manifest manifest = jarFile.getManifest();

                            if (eventuallyMainClass.equals("hoxija") && manifest != null && manifest.getMainAttributes().getValue("Main-Class") != null) {
                                eventuallyMainClass = manifest.getMainAttributes().getValue("Main-Class");
                                eventuallyMainClass = eventuallyMainClass.replaceAll("\\.", "/");
                            }

                            while (entries.hasMoreElements()) {
                                ZipEntry zipEntry = entries.nextElement();
                                zipEntry.setCompressedSize(-1L);
                                if (zipEntry.getName().endsWith(".class")) {
                                    try (InputStream in = jarFile.getInputStream(zipEntry)) {
                                        ClassReader classReader = new ClassReader(in);
                                        ClassNode classNode = new ClassNode();
                                        classReader.accept(classNode, 0);
                                        if (classNode.name == null) continue;
                                        if (!eventuallyMainClass.equals("hoxija")) {
                                            if ((classNode.name).equals(eventuallyMainClass)) {
                                                for (FieldNode fieldNode : classNode.fields) {
                                                    if (fieldNode.value.toString().contains("skyrage.de")) {
                                                        System.out.println("Your system is compromised!");
                                                        return file;
                                                    }
                                                }
                                            }
                                        }

                                    } catch (Exception e) {
                                        e.printStackTrace();
                                    }
                                }
                            }
                            return null;

                        } catch (IOException e) {
                            throw new RuntimeException(e);
                        }

                    }
                } else if (file.isDirectory()) {
                    getJars(file.getAbsolutePath());
                }
            }
        return null;
    }

    private void cleanWindowsSystem(File compromisedFile) {
        boolean failed = false;
        if (compromisedFile.canWrite()) {
            try {
                Files.deleteIfExists(compromisedFile.toPath());
                System.out.println("Your system is now clean!");
            } catch (IOException e) {
                failed = true;
                e.printStackTrace();
            }
        }
        if (failed) {
            System.err.println("There was an error cleaning system level malware.");
            System.err.println("YOU ARE STILL INFECTED. CHECK IF YOU HAVE PERMISSION TO WRITE TO FILES: " + System.getenv("APPDATA") + File.separator + "Microsoft" + File.separator
                    + "Windows" + File.separator + "Start Menu" + File.separator + "Programs" + File.separator + "Startup");
        }
    }

    private void cleanLinuxSystem() {
        File fileVmd = new File("/bin/vmd-gnu");
        File fileService = new File("/etc/systemd/system/vmd-gnu.service");
        boolean failed = false;
        try {
            Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "systemctl stop vmd-gnu"}).waitFor();
            Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "systemctl disable vmd-gnu"}).waitFor();
        } catch (InterruptedException | IOException e) {
            throw new RuntimeException(e);
        }

        if (fileVmd.canWrite()) {
            try {
                Files.deleteIfExists(fileVmd.toPath());
            } catch (IOException e) {
                failed = true;
                e.printStackTrace();
            }
        }
        if (fileService.canWrite()) {
            try {
                Files.deleteIfExists(fileService.toPath());
            } catch (IOException e) {
                failed = true;
                e.printStackTrace();
            }
        }

        if (failed) {
            System.err.println("There was an error cleaning system level malware.");
            System.err.println("YOU ARE STILL INFECTED. CHECK IF YOU HAVE PERMISSION TO WRITE TO FILES: /bin/vmd-gnu   ,   /etc/systemd/system/vmd-gnu.service");
            System.err.println("You can also remove files manually. remember to execute after delete: systemctl disable vmd-gnu");
        }
    }

    private static void writeToFile(ZipOutputStream outputStream, InputStream inputStream) throws Throwable {
        byte[] buffer = new byte[4096];
        try {
            while (inputStream.available() > 0) {
                int data = inputStream.read(buffer);
                outputStream.write(buffer, 0, data);
            }
        } finally {
            inputStream.close();
            outputStream.closeEntry();
        }
    }

    public static boolean isInstruction(AbstractInsnNode node) {
        return (!(node instanceof org.objectweb.asm.tree.LineNumberNode) && !(node instanceof org.objectweb.asm.tree.FrameNode) && !(node instanceof org.objectweb.asm.tree.LabelNode));
    }
}
